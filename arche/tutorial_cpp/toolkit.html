

<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Adding Buffers and Policies from the Toolkit &#8212; Home</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/cyclus.css?v=a0e5ed17" />
    <link rel="stylesheet" type="text/css" href="../../_static/table_styling.css?v=a1a2a898" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script src="../../_static/documentation_options.js?v=8cf7d53e"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>

    
    
     
        <script src="../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../_static/cloud.js"></script>
    

    <link rel="icon" href="../../_static/big_c.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Adding a Test" href="testing.html" />
    <link rel="prev" title="Adding State Variables" href="state_var.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1"><script type="text/javascript">
var ga_enabled = !$.cookie('disable-ga');
if(ga_enabled){
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-12222727-2']);
  _gaq.push(['_setCookiePath', '/']);
  _gaq.push(['_setDetectFlash', false]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
}
</script>
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="testing.html" title="Adding a Test"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="state_var.html" title="Adding State Variables"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Home</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" ><span style="font-variant:small-caps;">Cyclus</span> Archetype Developer Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Archetype Development Tutorial [C++]</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Adding Buffers and Policies from the Toolkit</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="adding-buffers-and-policies-from-the-toolkit">
<h1>Adding Buffers and Policies from the Toolkit<a class="headerlink" href="#adding-buffers-and-policies-from-the-toolkit" title="Link to this heading">¶</a></h1>
<p>In this lesson, we will:</p>
<ol class="arabic simple">
<li><p>Add ResBufs to track material inventories</p></li>
<li><p>Add Policies to manage the trading of material</p></li>
<li><p>Add inventory management logic</p></li>
<li><p>Change our log information to show the info about the inventories</p></li>
<li><p>Add a notion of total storage capacity</p></li>
</ol>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Cyclus has a growing Toolkit of standard patterns that can be used by
archetype developers.  There are many advantages to using the Toolkit patterns
rather than developing similar functionality yourself, typical of most code
reuse situations:</p>
<ul class="simple">
<li><p>robustness - Toolkit patterns have been subjected to the Cyclus QA process</p></li>
<li><p>time savings - It will take less time to learn how to use a Toolkit than it takes to develop your own</p></li>
<li><p>improvements - You can benefit immediately from any improvements in the performance of the Toolkit pattern</p></li>
</ul>
<p>Code reuse is a critical best practice in all software development.</p>
<p>One of the Toolkit patterns is a <code class="docutils literal notranslate"><span class="pre">ResBuf</span></code>, providing a way to track an
inventory of <code class="docutils literal notranslate"><span class="pre">Resource</span></code> objects. There are also <code class="docutils literal notranslate"><span class="pre">MatlBuyPolicy</span></code> and
<code class="docutils literal notranslate"><span class="pre">MatlSellPolicy</span></code> for managing the trading of <code class="docutils literal notranslate"><span class="pre">Material</span></code> objects.</p>
</section>
<section id="add-state-variables-buffers-and-policies">
<h2>Add State Variables, Buffers, and Policies<a class="headerlink" href="#add-state-variables-buffers-and-policies" title="Link to this heading">¶</a></h2>
<p>All state variable additions should be included in <code class="docutils literal notranslate"><span class="pre">src/storage.h</span></code> below the
other state variables added previously.</p>
<blockquote>
<div><p>A <code class="docutils literal notranslate"><span class="pre">ResBuf</span></code> is available as a data type for another state variable, so we
simply have to add the following:</p>
</div></blockquote>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">/// this facility holds material in storage.</span>
<span class="cp">#pragma cyclus var {}</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">toolkit</span><span class="o">::</span><span class="n">ResBuf</span><span class="o">&lt;</span><span class="n">cyclus</span><span class="o">::</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">inventory</span><span class="p">;</span>
</pre></div>
</div>
<p>This creates a state variable named <code class="docutils literal notranslate"><span class="pre">inventory</span></code> that is based on the
<code class="docutils literal notranslate"><span class="pre">cyclus::toolkit::ResBuf</span></code> class.  We’ll explain how buffers and policies
work in just a moment.  A ResBuf object has special handling by the
preprocessor, so it will not appear in the schema and therefore will not
appear in the Cycic UI either.</p>
<p>Next, add two additional buffers</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">/// a buffer for incoming material</span>
<span class="cp">#pragma cyclus var {}</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">toolkit</span><span class="o">::</span><span class="n">ResBuf</span><span class="o">&lt;</span><span class="n">cyclus</span><span class="o">::</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input</span><span class="p">;</span>

<span class="c1">/// a buffer for outgoing material</span>
<span class="cp">#pragma cyclus var {}</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">toolkit</span><span class="o">::</span><span class="n">ResBuf</span><span class="o">&lt;</span><span class="n">cyclus</span><span class="o">::</span><span class="n">Material</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
</pre></div>
</div>
<p>Now add the policies. Policies do not require any special handling, and
thus do not need a pragma</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">/// a policy for requesting material</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">toolkit</span><span class="o">::</span><span class="n">MatlBuyPolicy</span><span class="w"> </span><span class="n">buy_policy</span><span class="p">;</span>

<span class="c1">/// a policy for sending material</span>
<span class="n">cyclus</span><span class="o">::</span><span class="n">toolkit</span><span class="o">::</span><span class="n">MatlSellPolicy</span><span class="w"> </span><span class="n">sell_policy</span><span class="p">;</span>
</pre></div>
</div>
<p>There needs to be a mechansim for keeping track of when materials enter the
inventory. In order to utilize Cyclus’ sophisticated restart capability, we must
choose a data structure that is compatible with the at least one of the Cyclus
output databases (see <a class="reference internal" href="../dbtypes.html#dbtypes"><span class="std std-ref">Database Types</span></a>). Given that requirement, an appropriate
data structure is a <a class="reference external" href="http://www.cplusplus.com/reference/list/list/">list</a>. Accordingly, add the
following</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">/// list for material entry times, providing a default lets this variable be</span>
<span class="c1">/// optional in an input file</span>
<span class="cp">#pragma cyclus var { \</span>
<span class="cp">  &quot;default&quot;: [] \</span>
<span class="cp">}</span>
<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry_times</span><span class="p">;</span>
</pre></div>
</div>
<p>This requires another header file, so at the top of the storage.h file, after
<code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;string&gt;</span></code>, add another include</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;list&gt;</span>
</pre></div>
</div>
<p>Finally, check that everything works by installing and testing</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./install.py
<span class="gp">$ </span>Storage_unit_tests
</pre></div>
</div>
<p>You can also confirm that everything still works with running the simulation:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cyclus<span class="w"> </span>-v<span class="w"> </span><span class="m">3</span><span class="w"> </span>input/storage.xml
<span class="go">              :</span>
<span class="go">          .CL:CC CC             _Q     _Q  _Q_Q    _Q    _Q              _Q</span>
<span class="go">        CC;CCCCCCCC:C;         /_\)   /_\)/_/\\)  /_\)  /_\)            /_\)</span>
<span class="go">        CCCCCCCCCCCCCl       __O|/O___O|/O_OO|/O__O|/O__O|/O____________O|/O__</span>
<span class="go">     CCCCCCf     iCCCLCC     /////////////////////////////////////////////////</span>
<span class="go">     iCCCt  ;;;;;.  CCCC</span>
<span class="go">    CCCC  ;;;;;;;;;. CClL.                          c</span>
<span class="go">   CCCC ,;;       ;;: CCCC  ;                   : CCCCi</span>
<span class="go">    CCC ;;         ;;  CC   ;;:                CCC`   `C;</span>
<span class="go">  lCCC ;;              CCCC  ;;;:             :CC .;;. C;   ;    :   ;  :;;</span>
<span class="go">  CCCC ;.              CCCC    ;;;,           CC ;    ; Ci  ;    :   ;  :  ;</span>
<span class="go">   iCC :;               CC       ;;;,        ;C ;       CC  ;    :   ; .</span>
<span class="go">  CCCi ;;               CCC        ;;;.      .C ;       tf  ;    :   ;  ;.</span>
<span class="go">  CCC  ;;               CCC          ;;;;;;; fC :       lC  ;    :   ;    ;:</span>
<span class="go">   iCf ;;               CC         :;;:      tC ;       CC  ;    :   ;     ;</span>
<span class="go">  fCCC :;              LCCf      ;;;:         LC :.  ,: C   ;    ;   ; ;   ;</span>
<span class="go">  CCCC  ;;             CCCC    ;;;:           CCi `;;` CC.  ;;;; :;.;.  ; ,;</span>
<span class="go">    CCl ;;             CC    ;;;;              CCC    CCL</span>
<span class="go">   tCCC  ;;        ;; CCCL  ;;;                  tCCCCC.</span>
<span class="go">    CCCC  ;;     :;; CCCCf  ;                     ,L</span>
<span class="go">     lCCC   ;;;;;;  CCCL</span>
<span class="go">     CCCCCC  :;;  fCCCCC</span>
<span class="go">      . CCCC     CCCC .</span>
<span class="go">       .CCCCCCCCCCCCCi</span>
<span class="go">          iCCCCCLCf</span>
<span class="go">           .  C. ,</span>
<span class="go">              :</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">INFO1(core  ):Simulation set to run from start=0 to end=10</span>
<span class="go">INFO1(core  ):Beginning simulation</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>
<span class="go">INFO1(tutori):Hello</span>
<span class="go">INFO1(tutori):World!</span>

<span class="go">Status: Cyclus run successful!</span>
<span class="go">Output location: cyclus.sqlite</span>
<span class="go">Simulation ID: 9f15b93c-9ab2-49bb-a14f-fef872e64ce8</span>
</pre></div>
</div>
</section>
<section id="add-implementation-logic">
<h2>Add Implementation Logic<a class="headerlink" href="#add-implementation-logic" title="Link to this heading">¶</a></h2>
<p>The goal of a storage facility is to ask for material up to some limit, store it
for an amount of time, and then send it on to any interested parties. This can
be implemented in Cyclus by utilizing the Toolkit objects stated above. The buy
and sell policies will automatically fill and empty the input and output
buffers, respectively.  A concept of material flow through the facility is
shown below.</p>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="../../_images/storage_diagram.svg"><img alt="../../_images/storage_diagram.svg" src="../../_images/storage_diagram.svg" width="75%" /></a>
<figcaption>
<p><span class="caption-text"><strong>Figure:</strong> Material flow through a Storage facility. Green arrows occur
<strong>before</strong> the DRE (during the Tick). Yellow arrows occur during the
DRE. Brown arrows occur <strong>after</strong> the DRE (during the Tock).</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<section id="connect-buffers-and-policies">
<h3>Connect Buffers and Policies<a class="headerlink" href="#connect-buffers-and-policies" title="Link to this heading">¶</a></h3>
<p>In order for policies to be utilized, they must be connected to their respective
buffers. The storage facility would like them always connected; accordingly,
that operation should happen at the time when the facility enters a
simulation. The kernel will let agents know that they are entering a simulation
via the <code class="docutils literal notranslate"><span class="pre">EnterNotify()</span></code> function.</p>
<p>Add the following to <code class="docutils literal notranslate"><span class="pre">src/storage.h</span></code> before the <code class="docutils literal notranslate"><span class="pre">Tick()</span></code> function</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">/// set up policies and buffers</span>
<span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">EnterNotify</span><span class="p">();</span>
</pre></div>
</div>
<p>And add the following to <code class="docutils literal notranslate"><span class="pre">src/storage.cc</span></code> before the <code class="docutils literal notranslate"><span class="pre">Tick()</span></code> function</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Storage::EnterNotify</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">cyclus</span><span class="o">::</span><span class="n">Facility</span><span class="o">::</span><span class="n">EnterNotify</span><span class="p">();</span><span class="w"> </span><span class="c1">// call base function first</span>
<span class="w">  </span><span class="n">buy_policy</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;input&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">throughput</span><span class="p">).</span><span class="n">Set</span><span class="p">(</span><span class="n">incommod</span><span class="p">).</span><span class="n">Start</span><span class="p">();</span>
<span class="w">  </span><span class="n">sell_policy</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">throughput</span><span class="p">).</span><span class="n">Set</span><span class="p">(</span><span class="n">outcommod</span><span class="p">).</span><span class="n">Start</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="buffer-transfer-logic">
<h3>Buffer Transfer Logic<a class="headerlink" href="#buffer-transfer-logic" title="Link to this heading">¶</a></h3>
<p>The job of the <code class="docutils literal notranslate"><span class="pre">Storage</span></code> archetype developer is to determine and implement
the logic related to transfering material between the input and output buffers
and the middle inventory buffer. Two rules govern buffer transfer logic
in this model:</p>
<ol class="arabic simple">
<li><p>All material in the input buffer is transferred to the inventory buffer</p></li>
<li><p>Material in the inventory buffer that has been stored for long enough is
transferred to the output buffer</p></li>
</ol>
<p>Because the input buffer transfer should occur <em>after</em> the DRE, it must happen
in the <code class="docutils literal notranslate"><span class="pre">Tock()</span></code> method. Similarly, because the output buffer transfer should
occur <em>before</em> the DRE, it must happen in the <code class="docutils literal notranslate"><span class="pre">Tick()</span></code> method. For each
transfer, care must be taken to update the <code class="docutils literal notranslate"><span class="pre">entry_times</span></code> list appropriately.</p>
<p>The input buffer transfer requires the following operation for each object in
the buffer:</p>
<ol class="arabic simple">
<li><p><em>Pop</em> the object from the input buffer</p></li>
<li><p><em>Push</em> the object to the inventory buffer</p></li>
<li><p><em>Push</em> the current time to the <code class="docutils literal notranslate"><span class="pre">entry_times</span></code></p></li>
</ol>
<p>In order to implement this, replace the current <code class="docutils literal notranslate"><span class="pre">Tock()</span></code> implementation in
<code class="docutils literal notranslate"><span class="pre">src/storage.cc</span></code> with</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Storage::Tock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">();</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">inventory</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">Pop</span><span class="p">());</span>
<span class="w">    </span><span class="n">entry_times</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The output buffer transfer requires the following operation so long as the
condition in 1. is met:</p>
<ol class="arabic simple">
<li><p>Check whether enough time has passed since the time at the front of
<code class="docutils literal notranslate"><span class="pre">entry_times</span></code> <em>and</em> the inventory is not empty. If so:</p></li>
<li><p><em>Pop</em> an object from the inventory buffer</p></li>
<li><p><em>Push</em> that object to the output buffer</p></li>
<li><p><em>Pop</em> a time from the <code class="docutils literal notranslate"><span class="pre">entry_times</span></code></p></li>
</ol>
<p>In order to implement this, replace the current <code class="docutils literal notranslate"><span class="pre">Tick()</span></code> implementation in
<code class="docutils literal notranslate"><span class="pre">src/storage.cc</span></code> with</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Storage::Tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">finished_storing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">storage_time</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inventory</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">entry_times</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">finished_storing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">output</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">inventory</span><span class="p">.</span><span class="n">Pop</span><span class="p">());</span>
<span class="w">    </span><span class="n">entry_times</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="build-and-test">
<h3>Build and Test<a class="headerlink" href="#build-and-test" title="Link to this heading">¶</a></h3>
<p>Same as it ever was</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./install.py
<span class="gp">$ </span>Storage_unit_tests
</pre></div>
</div>
</section>
</section>
<section id="add-some-logging">
<h2>Add Some Logging<a class="headerlink" href="#add-some-logging" title="Link to this heading">¶</a></h2>
<p>Now that all of the required logic is there, it would be nice to know some
information about what is happening to a facility during a simulation. This is
accomplished in Cyclus through <a class="reference internal" href="../logger.html#logging"><span class="std std-ref">Logging</span></a>, which is implemented as a stream
operation.</p>
<p>Information about the current inventory can be added by updating the <code class="docutils literal notranslate"><span class="pre">Tock()</span></code>
function (after any pushing/popping) with</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">LOG</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">LEV_INFO2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storage&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;The total inventory at time &quot;</span>
<span class="w">                                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; is &quot;</span>
<span class="w">                                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">inventory</span><span class="p">.</span><span class="n">quantity</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">quantity</span><span class="p">()</span>
<span class="w">                                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; kg.&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>After updating the function should look something like</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Storage::Tock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">();</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">inventory</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">Pop</span><span class="p">());</span>
<span class="w">    </span><span class="n">entry_times</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">LOG</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">LEV_INFO2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storage&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;The total inventory at time &quot;</span>
<span class="w">                                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; is &quot;</span>
<span class="w">                                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">inventory</span><span class="p">.</span><span class="n">quantity</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">quantity</span><span class="p">()</span>
<span class="w">                                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; kg.&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice that this uses the built in <code class="docutils literal notranslate"><span class="pre">quantity()</span></code> method of a ResBuf
object and that both the <code class="docutils literal notranslate"><span class="pre">inventory</span></code> and <code class="docutils literal notranslate"><span class="pre">output</span></code> buffers are queried. While
the implementation logic requires multiple buffers, the model assumes the
facility acts as a single cohesive unit.</p>
<p>You can also add information about the quantity of material that will be
requested and offered. Since this information is important to know <em>before</em> the
DRE, it goes in the <code class="docutils literal notranslate"><span class="pre">Tick()</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">LOG</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">LEV_INFO2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storage&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Quantity to be requested: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">buy_policy</span><span class="p">.</span><span class="n">TotalQty</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; kg.&quot;</span><span class="p">;</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">LEV_INFO2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storage&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Quantity to be offered: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sell_policy</span><span class="p">.</span><span class="n">Limit</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; kg.&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>After updating the function should look something like</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Storage::Tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">finished_storing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">storage_time</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inventory</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">entry_times</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">finished_storing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">output</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">inventory</span><span class="p">.</span><span class="n">Pop</span><span class="p">());</span>
<span class="w">        </span><span class="n">entry_times</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">LOG</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">LEV_INFO2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storage&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Quantity to be requested: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">buy_policy</span><span class="p">.</span><span class="n">TotalQty</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; kg.&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">LOG</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">LEV_INFO2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storage&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Quantity to be offered: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sell_policy</span><span class="p">.</span><span class="n">Limit</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; kg.&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To see the logging output, build and rerun the simulation</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Increase the verbosity from <code class="docutils literal notranslate"><span class="pre">2</span></code> to <code class="docutils literal notranslate"><span class="pre">3</span></code>.</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./install.py
<span class="gp">$ </span>cyclus<span class="w"> </span>-v<span class="w"> </span><span class="m">3</span><span class="w"> </span>input/storage.xml
<span class="go">              :</span>
<span class="go">          .CL:CC CC             _Q     _Q  _Q_Q    _Q    _Q              _Q</span>
<span class="go">        CC;CCCCCCCC:C;         /_\)   /_\)/_/\\)  /_\)  /_\)            /_\)</span>
<span class="go">        CCCCCCCCCCCCCl       __O|/O___O|/O_OO|/O__O|/O__O|/O____________O|/O__</span>
<span class="go">     CCCCCCf     iCCCLCC     /////////////////////////////////////////////////</span>
<span class="go">     iCCCt  ;;;;;.  CCCC</span>
<span class="go">    CCCC  ;;;;;;;;;. CClL.                          c</span>
<span class="go">   CCCC ,;;       ;;: CCCC  ;                   : CCCCi</span>
<span class="go">    CCC ;;         ;;  CC   ;;:                CCC`   `C;</span>
<span class="go">  lCCC ;;              CCCC  ;;;:             :CC .;;. C;   ;    :   ;  :;;</span>
<span class="go">  CCCC ;.              CCCC    ;;;,           CC ;    ; Ci  ;    :   ;  :  ;</span>
<span class="go">   iCC :;               CC       ;;;,        ;C ;       CC  ;    :   ; .</span>
<span class="go">  CCCi ;;               CCC        ;;;.      .C ;       tf  ;    :   ;  ;.</span>
<span class="go">  CCC  ;;               CCC          ;;;;;;; fC :       lC  ;    :   ;    ;:</span>
<span class="go">   iCf ;;               CC         :;;:      tC ;       CC  ;    :   ;     ;</span>
<span class="go">  fCCC :;              LCCf      ;;;:         LC :.  ,: C   ;    ;   ; ;   ;</span>
<span class="go">  CCCC  ;;             CCCC    ;;;:           CCi `;;` CC.  ;;;; :;.;.  ; ,;</span>
<span class="go">    CCl ;;             CC    ;;;;              CCC    CCL</span>
<span class="go">   tCCC  ;;        ;; CCCL  ;;;                  tCCCCC.</span>
<span class="go">    CCCC  ;;     :;; CCCCf  ;                     ,L</span>
<span class="go">     lCCC   ;;;;;;  CCCL</span>
<span class="go">     CCCCCC  :;;  fCCCCC</span>
<span class="go">      . CCCC     CCCC .</span>
<span class="go">       .CCCCCCCCCCCCCi</span>
<span class="go">          iCCCCCLCf</span>
<span class="go">           .  C. ,</span>
<span class="go">              :</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go"> INFO1(core  ):Simulation set to run from start=0 to end=10</span>
<span class="go"> INFO1(core  ):Beginning simulation</span>
<span class="go"> INFO1(core  ):Current time: 0</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 0</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 0</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 0</span>
<span class="go"> INFO2(Storag):  The total inventory at time 0 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 1</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 1</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 1</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 1</span>
<span class="go"> INFO2(Storag):  The total inventory at time 1 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 2</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 2</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 2</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 2</span>
<span class="go"> INFO2(Storag):  The total inventory at time 2 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 3</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 3</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 3</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 3</span>
<span class="go"> INFO2(Storag):  The total inventory at time 3 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 4</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 4</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 4</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 4</span>
<span class="go"> INFO2(Storag):  The total inventory at time 4 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 5</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 5</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 5</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 5</span>
<span class="go"> INFO2(Storag):  The total inventory at time 5 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 6</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 6</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 6</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 6</span>
<span class="go"> INFO2(Storag):  The total inventory at time 6 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 7</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 7</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 7</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 7</span>
<span class="go"> INFO2(Storag):  The total inventory at time 7 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 8</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 8</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 8</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 8</span>
<span class="go"> INFO2(Storag):  The total inventory at time 8 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 9</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 9</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 10 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 9</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 9</span>
<span class="go"> INFO2(Storag):  The total inventory at time 9 is 0 kg of material.</span>

<span class="go">Status: Cyclus run successful!</span>
<span class="go">Output location: cyclus.sqlite</span>
<span class="go">Simulation ID: 747f6c86-fce8-49be-8c57-8bb38e11761a</span>
</pre></div>
</div>
</section>
<section id="add-a-state-variable-to-define-storage-capcity">
<h2>Add a State Variable to Define Storage Capcity<a class="headerlink" href="#add-a-state-variable-to-define-storage-capcity" title="Link to this heading">¶</a></h2>
<p>A natural extension for the current storage facility implementation is to have a
maximum storage capacity. To do so, first add a capacity state variable to
storage.h . If you still want the input file to work, you have to provide a
<code class="docutils literal notranslate"><span class="pre">default</span></code> key in the pragma data structure. A sufficiently large value will
do.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma cyclus var { \</span>
<span class="cp">  &#39;doc&#39;: &#39;Maximum storage capacity (including all material in the facility)&#39;, \</span>
<span class="cp">  &#39;tooltip&#39;: &#39;Maximum storage capacity&#39;, \</span>
<span class="cp">  &#39;units&#39;: &#39;kg&#39;, \</span>
<span class="cp">  &#39;default&#39;: 1e200, \</span>
<span class="cp">  &#39;uilabel&#39;: &#39;Maximum Storage Capacity&#39; \</span>
<span class="cp">}</span>
<span class="kt">double</span><span class="w"> </span><span class="n">capacity</span><span class="p">;</span>
</pre></div>
</div>
<p>The required implementation is nontrivial. The goal of adding a capacity
member is to guarantee that the amount of material in the facility never exceeds
a certain value. The only way for material to enter the facility is through the
<code class="docutils literal notranslate"><span class="pre">input</span></code> ResBuff via the <code class="docutils literal notranslate"><span class="pre">buy_policy</span></code>. The <code class="docutils literal notranslate"><span class="pre">MatlBuyPolicy</span></code> sets a maximum
buy amount based on both its <code class="docutils literal notranslate"><span class="pre">throughput</span></code> and the <code class="docutils literal notranslate"><span class="pre">capacity</span></code> of the
connected <code class="docutils literal notranslate"><span class="pre">ResBuf</span></code>. Accordingly, you can update the <code class="docutils literal notranslate"><span class="pre">input</span></code> buffer’s
capacity before the DRE occurs to achieve this behavior.</p>
<figure class="align-center" id="id3">
<img alt="../../_images/storage_capacity.svg" src="../../_images/storage_capacity.svg" /><figcaption>
<p><span class="caption-text"><strong>Figure:</strong> Storage buffers between two time steps. The total capacity is
represented by the area of all three boxes. The <code class="docutils literal notranslate"><span class="pre">input</span></code> buffer’s capacity
must be updated to reflect how much material is in both the <code class="docutils literal notranslate"><span class="pre">inventory</span></code>
and <code class="docutils literal notranslate"><span class="pre">output</span></code> buffers. The colored arrows on the right match the material
flows in the previous figure.</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>To do so, add the following line to the end of the <code class="docutils literal notranslate"><span class="pre">Tick()</span></code> function (in the
implementation file), which updates capacity of the <code class="docutils literal notranslate"><span class="pre">input</span></code> through the
<code class="docutils literal notranslate"><span class="pre">ResBuf</span></code> <code class="docutils literal notranslate"><span class="pre">capacity()</span></code> API</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// only allow requests up to the storage capacity</span>
<span class="n">input</span><span class="p">.</span><span class="n">capacity</span><span class="p">(</span><span class="n">capacity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">inventory</span><span class="p">.</span><span class="n">quantity</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">quantity</span><span class="p">());</span>
</pre></div>
</div>
<p>So the full <code class="docutils literal notranslate"><span class="pre">Tick()</span></code> function now looks like</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Storage::Tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">finished_storing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">storage_time</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inventory</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">entry_times</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">finished_storing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">output</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">inventory</span><span class="p">.</span><span class="n">Pop</span><span class="p">());</span>
<span class="w">    </span><span class="n">entry_times</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// only allow requests up to the storage capacity</span>
<span class="w">  </span><span class="n">input</span><span class="p">.</span><span class="n">capacity</span><span class="p">(</span><span class="n">capacity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">inventory</span><span class="p">.</span><span class="n">quantity</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">quantity</span><span class="p">());</span>

<span class="w">  </span><span class="n">LOG</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">LEV_INFO2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storage&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Quantity to be requested: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">buy_policy</span><span class="p">.</span><span class="n">TotalQty</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; kg.&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">LOG</span><span class="p">(</span><span class="n">cyclus</span><span class="o">::</span><span class="n">LEV_INFO2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storage&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Quantity to be offered: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sell_policy</span><span class="p">.</span><span class="n">Limit</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; kg.&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="id1">
<h3>Build and Test<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>Same as it ever was</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./install.py
<span class="gp">$ </span>Storage_unit_tests
</pre></div>
</div>
</section>
<section id="update-input-file-and-run">
<h3>Update Input File and Run<a class="headerlink" href="#update-input-file-and-run" title="Link to this heading">¶</a></h3>
<p>You can test that your new capacity capability works by adding the following to
the end of the <code class="docutils literal notranslate"><span class="pre">config</span></code> block for <code class="docutils literal notranslate"><span class="pre">Storage</span></code> (before the close tag
&lt;/Storage&gt;) in <code class="docutils literal notranslate"><span class="pre">input/storage.xml</span></code></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;capacity&gt;</span>8<span class="nt">&lt;/capacity&gt;</span>
</pre></div>
</div>
<p>Note that this capacity is smaller than the throughput! What do you think you
will see in the output logs?</p>
<p>Try it out (don’t forget to delete the old sqlite file first):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>rm<span class="w"> </span>cyclus.sqlite
<span class="gp">$ </span>cyclus<span class="w"> </span>-v<span class="w"> </span><span class="m">3</span><span class="w"> </span>input/storage.xml
<span class="go">              :</span>
<span class="go">          .CL:CC CC             _Q     _Q  _Q_Q    _Q    _Q              _Q</span>
<span class="go">        CC;CCCCCCCC:C;         /_\)   /_\)/_/\\)  /_\)  /_\)            /_\)</span>
<span class="go">        CCCCCCCCCCCCCl       __O|/O___O|/O_OO|/O__O|/O__O|/O____________O|/O__</span>
<span class="go">     CCCCCCf     iCCCLCC     /////////////////////////////////////////////////</span>
<span class="go">     iCCCt  ;;;;;.  CCCC</span>
<span class="go">    CCCC  ;;;;;;;;;. CClL.                          c</span>
<span class="go">   CCCC ,;;       ;;: CCCC  ;                   : CCCCi</span>
<span class="go">    CCC ;;         ;;  CC   ;;:                CCC`   `C;</span>
<span class="go">  lCCC ;;              CCCC  ;;;:             :CC .;;. C;   ;    :   ;  :;;</span>
<span class="go">  CCCC ;.              CCCC    ;;;,           CC ;    ; Ci  ;    :   ;  :  ;</span>
<span class="go">   iCC :;               CC       ;;;,        ;C ;       CC  ;    :   ; .</span>
<span class="go">  CCCi ;;               CCC        ;;;.      .C ;       tf  ;    :   ;  ;.</span>
<span class="go">  CCC  ;;               CCC          ;;;;;;; fC :       lC  ;    :   ;    ;:</span>
<span class="go">   iCf ;;               CC         :;;:      tC ;       CC  ;    :   ;     ;</span>
<span class="go">  fCCC :;              LCCf      ;;;:         LC :.  ,: C   ;    ;   ; ;   ;</span>
<span class="go">  CCCC  ;;             CCCC    ;;;:           CCi `;;` CC.  ;;;; :;.;.  ; ,;</span>
<span class="go">    CCl ;;             CC    ;;;;              CCC    CCL</span>
<span class="go">   tCCC  ;;        ;; CCCL  ;;;                  tCCCCC.</span>
<span class="go">    CCCC  ;;     :;; CCCCf  ;                     ,L</span>
<span class="go">     lCCC   ;;;;;;  CCCL</span>
<span class="go">     CCCCCC  :;;  fCCCCC</span>
<span class="go">      . CCCC     CCCC .</span>
<span class="go">       .CCCCCCCCCCCCCi</span>
<span class="go">          iCCCCCLCf</span>
<span class="go">           .  C. ,</span>
<span class="go">              :</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: ResBuf is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlBuyPolicy is experimental and its API may be subject to change</span>
<span class="go">Experimental Warning: MatlSellPolicy is experimental and its API may be subject to change</span>
<span class="go"> INFO1(core  ):Simulation set to run from start=0 to end=10</span>
<span class="go"> INFO1(core  ):Beginning simulation</span>
<span class="go"> INFO1(core  ):Current time: 0</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 0</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 0</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 0</span>
<span class="go"> INFO2(Storag):  The total inventory at time 0 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 1</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 1</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 1</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 1</span>
<span class="go"> INFO2(Storag):  The total inventory at time 1 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 2</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 2</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 2</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 2</span>
<span class="go"> INFO2(Storag):  The total inventory at time 2 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 3</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 3</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 3</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 3</span>
<span class="go"> INFO2(Storag):  The total inventory at time 3 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 4</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 4</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 4</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 4</span>
<span class="go"> INFO2(Storag):  The total inventory at time 4 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 5</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 5</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 5</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 5</span>
<span class="go"> INFO2(Storag):  The total inventory at time 5 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 6</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 6</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 6</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 6</span>
<span class="go"> INFO2(Storag):  The total inventory at time 6 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 7</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 7</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 7</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 7</span>
<span class="go"> INFO2(Storag):  The total inventory at time 7 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 8</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 8</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 8</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 8</span>
<span class="go"> INFO2(Storag):  The total inventory at time 8 is 0 kg of material.</span>
<span class="go"> INFO1(core  ):Current time: 9</span>
<span class="go"> INFO2(core  ):  Beginning Tick for time: 9</span>
<span class="go"> INFO2(Storag):  Quantity to be requested: 8 kg.</span>
<span class="go"> INFO2(Storag):  Quantity to be offered: 0 kg.</span>
<span class="go"> INFO2(core  ):  Beginning DRE for time: 9</span>
<span class="go"> INFO2(core  ):  Beginning Tock for time: 9</span>
<span class="go"> INFO2(Storag):  The total inventory at time 9 is 0 kg of material.</span>

<span class="go">Status: Cyclus run successful!</span>
<span class="go">Output location: cyclus.sqlite</span>
<span class="go">Simulation ID: 1ce98e9b-bd89-402b-8bd6-c8266e293dba</span>
</pre></div>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="../../index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Adding Buffers and Policies from the Toolkit</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#add-state-variables-buffers-and-policies">Add State Variables, Buffers, and Policies</a></li>
<li><a class="reference internal" href="#add-implementation-logic">Add Implementation Logic</a><ul>
<li><a class="reference internal" href="#connect-buffers-and-policies">Connect Buffers and Policies</a></li>
<li><a class="reference internal" href="#buffer-transfer-logic">Buffer Transfer Logic</a></li>
<li><a class="reference internal" href="#build-and-test">Build and Test</a></li>
</ul>
</li>
<li><a class="reference internal" href="#add-some-logging">Add Some Logging</a></li>
<li><a class="reference internal" href="#add-a-state-variable-to-define-storage-capcity">Add a State Variable to Define Storage Capcity</a><ul>
<li><a class="reference internal" href="#id1">Build and Test</a></li>
<li><a class="reference internal" href="#update-input-file-and-run">Update Input File and Run</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="state_var.html"
                          title="Previous page">&larr; Adding State Variables</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="testing.html"
                          title="Next page">&rarr; Adding a Test</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="testing.html" title="Adding a Test"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="state_var.html" title="Adding State Variables"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Home</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" ><span style="font-variant:small-caps;">Cyclus</span> Archetype Developer Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Archetype Development Tutorial [C++]</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Adding Buffers and Policies from the Toolkit</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2012-2024, University of Wisconsin Computational Nuclear Engineering Research Group.
      Last updated on Apr 01, 2024.
    </div><script type="text/javascript">
    if(ga_enabled){
        document.write("<div class=\"footer\">This page uses <a href=\"http://analytics.google.com\">Google Analytics</a> to collect statistics. ");
        document.write("Click <button title=\"set cookie to disable analytics for this site\" class=\"link\" onclick=\"$.cookie('disable-ga', 'true', {expires: 3650, path: '/'}); window.location.reload(); return false; \">here</button> to disable analytics for this site.");
        document.write("</div>");
    }else{
        document.write("<div class=\"footer\">Google Analytics has been disabled. ");
        document.write("Click <button title=\"set cookie to re-enable analytics for this site\" class=\"link\" onclick=\"$.cookie('disable-ga', null, {path: '/'}); window.location.reload(); return false; \">here</button> to re-enable analytics for this site.");
    };
</script>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>