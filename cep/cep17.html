


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CEP 17 - Resource Tracking and Interfaces Re-Re-Redo &mdash; Cyclus Home</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Cyclus Home" href="../index.html" />
    <link rel="up" title="Cyclus Enhancement Proposals" href="cep0.html" />
    <link rel="prev" title="CEP 1 - CEP Purpose and Guidelines" href="cep1.html" />
   
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-12222727-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
  <a href="http://cyclus.github.com">
    <img src="../_static/logo1.png"/>
  </a>
</div>


    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cep1.html" title="CEP 1 - CEP Purpose and Guidelines"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Cyclus Home</a> &raquo;</li>
          <li><a href="cep0.html" accesskey="U">Cyclus Enhancement Proposals</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">CEP 17 - Resource Tracking and Interfaces Re-Re-Redo</a><ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation-and-rationale">Motivation and Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#data-tracking">Data Tracking</a></li>
<li><a class="reference internal" href="#output-schema">Output Schema</a></li>
<li><a class="reference internal" href="#resources-material-api">Resources/Material API</a><ul>
<li><a class="reference internal" href="#resource-class">Resource class</a></li>
<li><a class="reference internal" href="#material-class">Material class</a></li>
<li><a class="reference internal" href="#genericresource-class">GenericResource class</a></li>
<li><a class="reference internal" href="#composition-class">Composition class</a></li>
<li><a class="reference internal" href="#matquery-class">MatQuery class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-changes">Other Changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#other-notes">Other Notes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="cep1.html"
                        title="previous chapter">CEP 1 - CEP Purpose and Guidelines</a></p>
  <h3>Useful Pages</h3>
    <li><a href="http://cyclus.github.com/basics/glossary.html">Glossary</a></li>
    <li><a href="http://cyclus.github.com/basics/roadmap.html">Roadmap</a></li>
    <li><a href="https://github.com/cyclus">Source Code</a></li>
    <li><a href="http://cnergdata.engr.wisc.edu/cyclus/core/docs/">Cyclus Core Documentation</a></li>
    
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
    <h3>Acknowledgements</h3>
    Support for this research has included funding received from:
    <img src=/_images/neup_logo_large.jpg width=170px>
    <img src=/_images/AnlLogo.png height=100px>
    <img src=/_images/USNRC.gif height=100px>
    <img src=/_images/nsf_logo.jpg height=100px>
    <img src=/_images/crest.png height=100px>

    

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="cep-17-resource-tracking-and-interfaces-re-re-redo">
<h1>CEP 17 - Resource Tracking and Interfaces Re-Re-Redo<a class="headerlink" href="#cep-17-resource-tracking-and-interfaces-re-re-redo" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">CEP:</th><td class="field-body">17</td>
</tr>
<tr class="field-even field"><th class="field-name">Title:</th><td class="field-body">Resource Tracking and Interfaces Re-Re-Redo</td>
</tr>
<tr class="field-odd field"><th class="field-name">Last-Modified:</th><td class="field-body">2013-07-05</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Robert Carlsen &lt;<a class="reference external" href="mailto:rwcarlsen&#37;&#52;&#48;gmail&#46;com">rwcarlsen<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt;</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
<tr class="field-even field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field-odd field"><th class="field-name">Created:</th><td class="field-body">Robert Carlsen</td>
</tr>
</tbody>
</table>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>This proposal serves to address two related issues:</p>
<ol class="arabic">
<li><p class="first"><strong>Resource tracking:</strong></p>
<p>Several types of analysis are made difficult to impossible by the
incomplete resource history currently recorded by Cyclus simulations. Such
analyses include agent time-dependent isotopic inventories and
proliferation-resistance material handling. It is proposed that all
resource state and state transitions will be tracked (as opposed to just
recording state at inter-agent transactions).  In addition to required
internal additions/changes to resource classes, explicit <cite>transmute</cite>
functionality will be added to the Material class to accommodate
mass-conserving state changes that occur in agents such as Reactors.</p>
</li>
<li><p class="first"><strong>Resource interface complexity:</strong></p>
<p>Creating, querying, and manipulating resources is too complex and is spread
across too many classes.  The resource class (and friends) will have their
interfaces minimized and all extra functionality will be provided by one or
more wrapper classes.</p>
</li>
</ol>
</div>
<div class="section" id="motivation-and-rationale">
<h2>Motivation and Rationale<a class="headerlink" href="#motivation-and-rationale" title="Permalink to this headline">¶</a></h2>
<p>This proposal serves to address two related issues: resource tracking and
resource interface complexity. Because changes to resource tracking will be
intrusive to the current resource interfaces, performing these changes
together is desirable.</p>
<p><strong>Resouce Tracking:</strong></p>
<p>Currently Cyclus only tracks the state of resources when they are transacted.
This limited tracking is problematic for certain kinds of output
analysis.  Examples:</p>
<ol class="arabic simple">
<li>The meaning of &#8220;inventory&#8221; for agents that transmute materials is
ill-defined.  To calculate the inventory of a reactor faciltiy, an
analysis of present data would show fresh fuel coming in, and spent fuel
coming out.  The aggregation of transactions to a specific point in time
would not be the reactor&#8217;s current inventory.  Rather it would be the
reactor&#8217;s inventory plus the difference between fresh and spent fuel
processed until that point in time. The same problem exists with decay.</li>
<li>We cannot determine if a resource was ever handled inappropriately (e.g.
non-proliferation analysis) internally within an agent.</li>
<li>We are unable to determine &#8220;source&#8221; agents that create material and what
they created.</li>
<li>There is no mass-conservation-safe way to transmute a material (i.e.
change its nuclide composition) outside of destroying and simultaneously
creating new material objects.</li>
<li>When resources are split and combined, there is no way to recall this
heritage.  Tracing paths of certain material objects is not possible.
Analyzing the contribution of agent X to the flow of element Y through
agent Z is not possible.</li>
</ol>
<p>The above deficiencies are used as drivers for designing/implementing a more
thorough resource tracking infrastructure.</p>
<p>Additionally, some materials will exist in the simulation that are not
&#8220;part&#8221; of the simulation and should not be recorded in the ouptut.  Some of
these materials will be objects representing what agents are
offering/requesting.  A new implementation must accomodate this
requirement.</p>
<p><strong>Resource Interface Complexity:</strong></p>
<p>The interface(s) for creating, manipulating, and using resources is too
confusing and complex.  There are methods for accessing material state
variables spread across three classes (Material, IsoVector, CompMap).  The
current trio will be reduced to a duo (Material and Composition classes).
All query convenience related methods will be moved to one (or more)
wrapper classes for interrogating and manipulating material compositions.
<em>Functionality provided by these wrapper classes can grow organically as
needs arise without affecting the core resource classes.</em></p>
</div>
<div class="section" id="specification">
<h2>Specification<a class="headerlink" href="#specification" title="Permalink to this headline">¶</a></h2>
<p>A reference implementation exists for both the cyclus core and cycamore.
These reside at <a class="reference external" href="https://github.com/rwcarlsen/cyclus">https://github.com/rwcarlsen/cyclus</a> (&#8220;res&#8221; branch) and
<a class="reference external" href="https://github.com/rwcarlsen/cycamore">https://github.com/rwcarlsen/cycamore</a> (&#8220;res&#8221; branch) respectively.  Further
implementation details can be found there.</p>
<div class="section" id="data-tracking">
<h3>Data Tracking<a class="headerlink" href="#data-tracking" title="Permalink to this headline">¶</a></h3>
<p>In addition to tracking the transfer of resources between agents (and
corresponding state), we track:</p>
<ul class="simple">
<li>Transmutation of a material resource within an agent (Resource,
ResourceHeritage, Compositions tables). This helps address problem
#1 and #4 from Motivation section.</li>
<li>Decay of a material resource (Resource, ResourceHeritage, Compositions
tables): This is a special, common case of transmutation.</li>
<li>All splitting/combining of materials. Tracked by recording the parent(s)
of each Resource object. Resources with no parent were newly created.
Helps address problem #2, #3 and #5.</li>
</ul>
<p>This also simplifies rules for acceptable resource handling, namely, it is
never okay for a resource to be destructed or thrown-away unless it is
being stored permanently. The new changes should make it more obvious to
agent developers how enforce correct, measurable mass-conservation.</p>
</div>
<div class="section" id="output-schema">
<h3>Output Schema<a class="headerlink" href="#output-schema" title="Permalink to this headline">¶</a></h3>
<p>All recorded data will stay the same except for the tables listed below:</p>
<ul class="simple">
<li>[TableName] ([new/modified/removed]): [field1], [field2], ...</li>
</ul>
<ul class="simple">
<li>Resource (modified): ID, type, quantity, units, StateID, Parent1, Parent2</li>
<li>Compositions (new): ID, Isotope, Quantity</li>
<li>TransactedResources (modified): TransactionID, Position, ResourceID</li>
<li>GenericResources (removed)</li>
<li>IsotopicStates (removed)</li>
</ul>
<p><em>Note that we no longer need a special table for Generic resources - it is
absorbed into the new &#8220;Resources&#8221; table.</em></p>
</div>
<div class="section" id="resources-material-api">
<h3>Resources/Material API<a class="headerlink" href="#resources-material-api" title="Permalink to this headline">¶</a></h3>
<p>The Material and Composition classes will be designed to provide only the
minimal interface to support basic manipulation and tracking required by the
cyclus core.  All more complex operations will be implemented in helper
classes (like MatQuery). A summary of each of these classes&#8217; new role and
its public+protected+private interfaces are listed below.</p>
<div class="section" id="resource-class">
<h4>Resource class<a class="headerlink" href="#resource-class" title="Permalink to this headline">¶</a></h4>
<p>Resource class provides an abstract interface allowing different types of
resources to be transacted in a simulation. It handles some basic state
tracking and output recording assisted by method invocations from its
subclasses.</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ResourceType</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Resource</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Resource</span><span class="o">&gt;</span> <span class="n">Ptr</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="o">~</span><span class="n">Resource</span><span class="p">();</span>

    <span class="c1">/// Unique for each material object.  Changes whenever *any* state changing</span>
    <span class="c1">/// operation is made.</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="nf">ID</span><span class="p">();</span>

    <span class="c1">/// Returns the units this resource is based in.</span>
    <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">units</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">/// returns the quantity of this resource with dimensions as specified by units().</span>
    <span class="k">virtual</span> <span class="kt">double</span> <span class="n">quantity</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">/// splits the resource and returns the extracted portion as a new resource</span>
    <span class="c1">/// object.  Allows for things like ResourceBuff and market matching to</span>
    <span class="c1">/// split offers/requests of arbitrary resource implementation type.</span>
    <span class="k">virtual</span> <span class="n">Ptr</span> <span class="n">extractRes</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="n">ResourceType</span> <span class="n">type</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">/// returns an untracked (not part of the simulation) copy of the resource.</span>
    <span class="k">virtual</span> <span class="n">Ptr</span> <span class="n">clone</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// the clone method implementations should set tracked_ = false.</span>

    <span class="c1">/// friends allow setting of tracked_ param when cloning in subclasses /</span>
    <span class="c1">/// without making it public. And also allow calling of changeState in create</span>
    <span class="c1">/// factory functions (wouldn&#39;t work even if protected because not changing</span>
    <span class="c1">/// on context &quot;this&quot;.</span>
    <span class="k">friend</span> <span class="k">class</span> <span class="nc">GenericResource</span><span class="p">;</span>
    <span class="k">friend</span> <span class="k">class</span> <span class="nc">Material</span><span class="p">;</span>

  <span class="nl">protected:</span>
    <span class="n">Resource</span><span class="p">();</span>

    <span class="c1">/// records the resource&#39;s state that is not accessible via the Resource /</span>
    <span class="c1">/// class interface (e.g. don&#39;t record units, quantity, etc) in its own</span>
    <span class="c1">/// table.</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">recordState</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">/// returns an id representing the specific resource implementation&#39;s internal state.</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">stateId</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


  <span class="nl">private:</span>
    <span class="c1">/// called by subclasses whenever any state changing operation has been</span>
    <span class="c1">/// performed. Updates the ID and recordes the resources state in the output</span>
    <span class="c1">/// database.</span>
    <span class="kt">void</span> <span class="nf">changeState</span><span class="p">(</span><span class="kt">int</span> <span class="n">parent1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parent2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">recordRes</span><span class="p">();</span>

    <span class="k">static</span> <span class="kt">int</span> <span class="n">nextId_</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id_</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">tracked_</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">parent1_</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">parent2_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="material-class">
<h4>Material class<a class="headerlink" href="#material-class" title="Permalink to this headline">¶</a></h4>
<p>The material class is primarily responsible for enabling basic material
manipulation while helping enforce mass conservation.  It also provides the
ability to easily decay a material up to the current simulation time; it
does not perform any decay related logic itself.</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Material</span><span class="o">:</span> <span class="k">public</span> <span class="n">Resource</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span> <span class="n">Ptr</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">ResourceType</span> <span class="n">Type</span><span class="p">;</span>

    <span class="k">static</span> <span class="n">Ptr</span> <span class="nf">create</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">c</span><span class="p">);</span>
    <span class="k">static</span> <span class="n">Ptr</span> <span class="nf">createUntracked</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">c</span><span class="p">);</span>

    <span class="k">virtual</span> <span class="o">~</span><span class="n">Material</span><span class="p">();</span>

    <span class="c1">/// returns &quot;kg&quot;</span>
    <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">units</span><span class="p">();</span>

    <span class="c1">/// returns the mass of this material in kg.</span>
    <span class="k">virtual</span> <span class="kt">double</span> <span class="nf">quantity</span><span class="p">();</span>

    <span class="k">virtual</span> <span class="n">ResourceType</span> <span class="nf">type</span><span class="p">();</span>

    <span class="k">virtual</span> <span class="kt">int</span> <span class="nf">stateId</span><span class="p">();</span>

    <span class="k">virtual</span> <span class="n">Resource</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">clone</span><span class="p">();</span>

    <span class="k">virtual</span> <span class="n">Resource</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">extractRes</span><span class="p">(</span><span class="kt">double</span> <span class="n">qty</span><span class="p">);</span>

    <span class="n">Ptr</span> <span class="nf">extractQty</span><span class="p">(</span><span class="kt">double</span> <span class="n">qty</span><span class="p">);</span>

    <span class="n">Ptr</span> <span class="nf">extractComp</span><span class="p">(</span><span class="kt">double</span> <span class="n">qty</span><span class="p">,</span> <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">c</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">absorb</span><span class="p">(</span><span class="n">Ptr</span> <span class="n">mat</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">transmute</span><span class="p">(</span><span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">c</span><span class="p">);</span>

    <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">comp</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">decay</span><span class="p">(</span><span class="kt">int</span> <span class="n">curr_time</span><span class="p">);</span>

    <span class="k">static</span> <span class="kt">void</span> <span class="nf">decayAll</span><span class="p">(</span><span class="kt">int</span> <span class="n">curr_time</span><span class="p">);</span>

  <span class="nl">protected:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">recordState</span><span class="p">();</span>

    <span class="n">Material</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">c</span><span class="p">);</span>

  <span class="nl">private:</span>
    <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">mix</span><span class="p">(</span><span class="kt">double</span> <span class="n">other_qty</span><span class="p">,</span> <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">other</span><span class="p">);</span>

    <span class="kt">double</span> <span class="n">qty_</span><span class="p">;</span>
    <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">comp_</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">prev_decay_time_</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">*</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&gt;</span> <span class="n">all_mats_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="genericresource-class">
<h4>GenericResource class<a class="headerlink" href="#genericresource-class" title="Permalink to this headline">¶</a></h4>
<p>Implements the Resource class interface.  No &#8220;quality&#8221; property is
provided.  It seemed redundant with &#8220;units&#8221;.  For a resource of quality
&#8220;bananas&#8221;, just use units like &#8220;kg bananas&#8221; (for mass based) or &#8220;# bananas&#8221;
(for count based).</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">GenericResource</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Resource</span> <span class="p">{</span> <span class="k">public</span><span class="o">:</span>
    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">GenericResource</span><span class="o">&gt;</span> <span class="n">Ptr</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">ResourceType</span> <span class="n">Type</span><span class="p">;</span>

    <span class="k">static</span> <span class="n">Ptr</span> <span class="nf">create</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">units</span><span class="p">);</span>
    <span class="k">static</span> <span class="n">Ptr</span> <span class="nf">createUntracked</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">units</span><span class="p">);</span>

    <span class="c1">/// Returns a reference to a newly allocated copy of this resource</span>
    <span class="k">virtual</span> <span class="n">Resource</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">clone</span><span class="p">();</span>

    <span class="c1">/// Returns the total quantity of this resource in its base unit</span>
    <span class="k">virtual</span> <span class="kt">double</span> <span class="nf">quantity</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="n">quantity_</span><span class="p">;};</span>

    <span class="c1">/// Returns the total quantity of this resource in its base unit</span>
    <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">units</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="n">units_</span><span class="p">;};</span>

    <span class="c1">/// Returns the concrete type of this resource</span>
    <span class="k">virtual</span> <span class="n">ResourceType</span> <span class="nf">type</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="n">Type</span><span class="p">;};</span>

    <span class="c1">/// not needed/no meaning for generic resources</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="nf">stateId</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="mi">0</span><span class="p">;};</span>

    <span class="cm">/**</span>
<span class="cm">       Absorbs the contents of the given &#39;other&#39; resource into this</span>
<span class="cm">       resource</span>
<span class="cm">       @throws CycGenResourceIncompatible &#39;other&#39; resource is of a</span>
<span class="cm">     */</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">absorb</span><span class="p">(</span><span class="n">GenericResource</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">other</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">       Extracts the specified mass from this resource and returns it as a</span>
<span class="cm">       new generic resource object with the same quality/type.</span>

<span class="cm">       @throws CycGenResourceOverExtract</span>
<span class="cm">     */</span>
    <span class="n">GenericResource</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">extract</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">);</span>

    <span class="k">virtual</span> <span class="n">Resource</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">extractRes</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">);</span>

  <span class="nl">protected:</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">recordState</span><span class="p">()</span> <span class="p">{</span> <span class="p">};</span>

  <span class="nl">private:</span>

    <span class="cm">/**</span>
<span class="cm">       @param quantity is a double indicating the quantity</span>
<span class="cm">       @param units is a string indicating the resource unit</span>
<span class="cm">     */</span>
    <span class="n">GenericResource</span><span class="p">(</span><span class="kt">double</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">units</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">       The units of the resource</span>
<span class="cm">     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">units_</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">       The quantity of the resource</span>
<span class="cm">     */</span>
    <span class="kt">double</span> <span class="n">quantity_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="composition-class">
<h4>Composition class<a class="headerlink" href="#composition-class" title="Permalink to this headline">¶</a></h4>
<p>An immutable object responsible for tracking decay lineages (to prevent
duplicate calculations and output recording) and able to record its
composition data to output when told.  Each composition will keep a pointer
to references to every other composition that is a result of decaying this
or a previously decayed-from composition.</p>
<p>Note that previously, composition creation/modification involved a notion
of equivalence via threshold comparison to facilitate reduced
memory/storage burdens.  This proposal discards this idea in favor of
defining equivalence trivially as &#8220;the same object in memory&#8221; or pointer
equality.  Some discussion regarding this can be found in comments here:
<a class="reference external" href="https://github.com/cyclus/cyclus/issues/484">https://github.com/cyclus/cyclus/issues/484</a>.  Of particular concern w.r.t.
the previous equivalence notion is this:</p>
<div class="highlight-python"><pre>Also - another potential issue I thought of: Repeatedly calling multiple
consecutive small differences negligible could result in compositions
staying the same that would have otherwise been appreciably different if
each small change were allowed to propogate as a new composition.</pre>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Composition</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Composition</span><span class="o">&gt;</span> <span class="n">Ptr</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">Iso</span><span class="p">,</span> <span class="kt">double</span><span class="o">&gt;</span> <span class="n">Vect</span><span class="p">;</span>

    <span class="k">static</span> <span class="n">Ptr</span> <span class="nf">createFromAtom</span><span class="p">(</span><span class="n">Vect</span> <span class="n">v</span><span class="p">);</span>
    <span class="k">static</span> <span class="n">Ptr</span> <span class="nf">createFromMass</span><span class="p">(</span><span class="n">Vect</span> <span class="n">v</span><span class="p">);</span>

    <span class="kt">int</span> <span class="nf">ID</span><span class="p">();</span>

    <span class="n">Ptr</span> <span class="nf">decay</span><span class="p">(</span><span class="kt">int</span> <span class="n">delta</span><span class="p">);</span>

    <span class="k">const</span> <span class="n">Vect</span><span class="o">&amp;</span> <span class="n">atomVect</span><span class="p">();</span>
    <span class="k">const</span> <span class="n">Vect</span><span class="o">&amp;</span> <span class="n">massVect</span><span class="p">();</span>

    <span class="c1">/// record in output database (if not done previously).</span>
    <span class="kt">void</span> <span class="nf">record</span><span class="p">();</span>

  <span class="nl">protected:</span>
    <span class="n">Composition</span><span class="p">();</span>

    <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span><span class="o">&gt;</span> <span class="n">Chain</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Chain</span><span class="o">&gt;</span> <span class="n">ChainPtr</span><span class="p">;</span>
    <span class="n">ChainPtr</span> <span class="n">decay_line_</span><span class="p">;</span>

  <span class="nl">private:</span>
    <span class="c1">// This constructor allows the creation of decayed versions of</span>
    <span class="c1">// compositions while avoiding extra memory allocations.</span>
    <span class="n">Composition</span><span class="p">(</span><span class="kt">int</span> <span class="n">prev_decay</span><span class="p">,</span> <span class="n">ChainPtr</span> <span class="n">decay_line</span><span class="p">);</span>

    <span class="n">Ptr</span> <span class="nf">newDecay</span><span class="p">(</span><span class="kt">int</span> <span class="n">delta</span><span class="p">);</span>

    <span class="c1">// normalizes the sum of all quantities in the composition&#39;s vector to one.</span>
    <span class="kt">void</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">Vect</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">);</span>

    <span class="k">static</span> <span class="kt">int</span> <span class="n">nextId_</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">id_</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">recorded_</span><span class="p">;</span>
    <span class="n">Vect</span> <span class="n">atomv_</span><span class="p">;</span>
    <span class="n">Vect</span> <span class="n">massv_</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">prev_decay_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="matquery-class">
<h4>MatQuery class<a class="headerlink" href="#matquery-class" title="Permalink to this headline">¶</a></h4>
<p>(This interface will probably need extension)</p>
<p>Will be designed to allow user-developers to <em>easily</em> retrieve any kind of
information about a material they could ever reasonably need.</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MatQuery</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="n">MatQuery</span><span class="p">(</span><span class="n">Material</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">m</span><span class="p">)</span> <span class="o">:</span> <span class="n">m_</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="kt">double</span> <span class="n">mass</span><span class="p">(</span><span class="n">Iso</span> <span class="n">iso</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">massFrac</span><span class="p">(</span><span class="n">iso</span><span class="p">)</span> <span class="o">*</span> <span class="n">qty</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">double</span> <span class="n">moles</span><span class="p">(</span><span class="n">Iso</span> <span class="n">iso</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">mass</span><span class="p">(</span><span class="n">iso</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">MT</span><span class="o">-&gt;</span><span class="n">gramsPerMol</span><span class="p">(</span><span class="n">iso</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">::</span><span class="n">g</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">double</span> <span class="n">massFrac</span><span class="p">(</span><span class="n">Iso</span> <span class="n">iso</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Composition</span><span class="o">::</span><span class="n">Vect</span> <span class="n">v</span> <span class="o">=</span> <span class="n">m_</span><span class="o">-&gt;</span><span class="n">comp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">massVect</span><span class="p">();</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">iso</span><span class="p">];</span>
    <span class="p">};</span>

    <span class="kt">double</span> <span class="nf">atomFrac</span><span class="p">(</span><span class="n">Iso</span> <span class="n">iso</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Composition</span><span class="o">::</span><span class="n">Vect</span> <span class="n">v</span> <span class="o">=</span> <span class="n">m_</span><span class="o">-&gt;</span><span class="n">comp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">atomVect</span><span class="p">();</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">iso</span><span class="p">];</span>
    <span class="p">};</span>

    <span class="kt">double</span> <span class="nf">qty</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">m_</span><span class="o">-&gt;</span><span class="n">quantity</span><span class="p">();</span>
    <span class="p">};</span>

  <span class="nl">private:</span>

    <span class="n">Material</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">m_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="other-changes">
<h3>Other Changes<a class="headerlink" href="#other-changes" title="Permalink to this headline">¶</a></h3>
<p>The RecipeLibrary&#8217;s role of composition decay management has been shifted
into the Composition class.  It now is only responsible for loading
recipes from xml input and serving them up simulation wide.  Agents are
also allowed to register their own compositions manually.</p>
<p><em>The decay lineage tracking functionality introduced by Matt Gidden has been
effectively preserved.</em></p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RecipeLibrary</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="cm">/**</span>
<span class="cm">     Gives all simulation objects global access to the RecipeLibrary by</span>
<span class="cm">     returning a pointer to it.</span>
<span class="cm">     Like the Highlander, there can be only one.</span>

<span class="cm">     @return a pointer to the RecipeLibrary</span>
<span class="cm">   */</span>
  <span class="k">static</span> <span class="n">RecipeLibrary</span><span class="o">*</span> <span class="n">Instance</span><span class="p">();</span>

  <span class="cm">/**</span>
<span class="cm">     loads the recipes from the input file</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="nf">load_recipes</span><span class="p">(</span><span class="n">QueryEngine</span><span class="o">*</span> <span class="n">qe</span><span class="p">);</span>

  <span class="cm">/**</span>
<span class="cm">     loads a specific recipe</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="nf">load_recipe</span><span class="p">(</span><span class="n">QueryEngine</span><span class="o">*</span> <span class="n">qe</span><span class="p">);</span>

  <span class="cm">/**</span>
<span class="cm">     records a new recipe in the simulation</span>
<span class="cm">     - records the recipe in the BookKeeper</span>

<span class="cm">     @param recipe the recipe to be recorded, a CompMapPtr</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="nf">addRecipe</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">c</span><span class="p">);</span>

  <span class="cm">/**</span>
<span class="cm">     This returns a CompMapPtr to the named recipe in the recipes_ map</span>

<span class="cm">     @param name the name of the parent recipe, a key in the recipes_ map</span>
<span class="cm">   */</span>
  <span class="n">Composition</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">getRecipe</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">);</span>

 <span class="nl">private:</span>
  <span class="n">RecipeLibrary</span><span class="p">();</span>

  <span class="c1">/// A pointer to this RecipeLibrary once it has been initialized.</span>
  <span class="k">static</span> <span class="n">RecipeLibrary</span><span class="o">*</span> <span class="n">instance_</span><span class="p">;</span>

  <span class="n">RecipeMap</span> <span class="n">recipes_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="backwards-compatibility">
<h2>Backwards Compatibility<a class="headerlink" href="#backwards-compatibility" title="Permalink to this headline">¶</a></h2>
<p>Most backwards incompatible changes are unambiguously described by the
reference implementation at <a class="reference external" href="https://github.com/rwcarlsen/cycamore">https://github.com/rwcarlsen/cycamore</a> (&#8220;res&#8221;
branch). Existing modules will need to be updated to use the new API&#8217;s.  These
changes are fairly straight forward and include:</p>
<ul class="simple">
<li>Material queries will have to be modified to use MatQuery class.</li>
<li>CompMap/IsoVector creation will need to change to use new Composition
factory methods.</li>
<li>Material creation will need to change to use new Material factory
methods.</li>
<li>Agents (esp. reactors) must be modified to transmute rather than
throw-away/create material.</li>
</ul>
</div>
<div class="section" id="other-notes">
<h2>Other Notes<a class="headerlink" href="#other-notes" title="Permalink to this headline">¶</a></h2>
<p>The current (before this CEP) Cyclus core does not correctly record decayed
compositions in the output database. This has the effect of comparing
simulation output size and performance with that of this CEP&#8217;s proposed
changes is not exactly &#8220;fair&#8221;.</p>
<p>Preliminary investigation on my part indicates that this extra tracking
will cause significant slowdown using an Sqlite backend database <em>when
material decay is frequent</em>.  This slowdown prompted the development of a
faster HDF5 alternative.  This alternate backend currently lives at
<a class="reference external" href="https://github.com/rwcarlsen/cyclus">https://github.com/rwcarlsen/cyclus</a> (&#8220;hdf5&#8221; branch).</p>
<p>Basic performance stats were collected by running a full cyclus
inpro_low.xml simulation <cite>time cyclus [path/to/]inpro_low.xml</cite>.  For
reference:</p>
<ul class="simple">
<li>~50,000 material objects total</li>
<li>1100 months</li>
<li>2200 decay calculations (2200 separate compositions recorded)</li>
<li>~28,000,000 resource object state changes recorded.</li>
</ul>
<p>Cyclus was built with CMake&#8217;s &#8220;RELEASE&#8221; mode.  Results reported are
approximate and specific to my office computer.</p>
<p>Without proposed changes (decayed compositions are not recorded - current bug):</p>
<table border="1" class="docutils">
<colgroup>
<col width="61%" />
<col width="20%" />
<col width="18%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&nbsp;</th>
<th class="head">&nbsp;</th>
<th class="head">&nbsp;</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Decay every 2nd timestep</td>
<td>41 sec.</td>
<td>17 sec.</td>
</tr>
<tr class="row-odd"><td>No decay</td>
<td>41 sec.</td>
<td>17 sec.</td>
</tr>
</tbody>
</table>
<p>With proposed changes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="53%" />
<col width="18%" />
<col width="29%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&nbsp;</th>
<th class="head">&nbsp;</th>
<th class="head">&nbsp;</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Decay every 2nd timestep</td>
<td>16 min.</td>
<td>2 min. 50 sec.</td>
</tr>
<tr class="row-odd"><td>No decay</td>
<td>55 sec.</td>
<td>21 sec.</td>
</tr>
</tbody>
</table>
<p>There has been some debate regarding the best way(s) to handle decaying
material objects in the simulation. Options include: manually by agents,
automatically and periodic, automatically at transaction time, and others.
While this involves the resource+material classes and can have a large
impact on simulation speed and output size, it has no direct impact on nor
directly impacts this proposal. Further discussion on this can be found
here <a class="reference external" href="https://github.com/cyclus/cyclus/issues/466">https://github.com/cyclus/cyclus/issues/466</a> and to lesser degree
<a class="reference external" href="https://github.com/cyclus/cyclus/issues/204">https://github.com/cyclus/cyclus/issues/204</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="cep1.html" title="CEP 1 - CEP Purpose and Guidelines"
             >previous</a> |</li>
        <li><a href="../index.html">Cyclus Home</a> &raquo;</li>
          <li><a href="cep0.html" >Cyclus Enhancement Proposals</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, University of Wisconsin Computational Nuclear Engineering Research Group.
      Last updated on Jul 05, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>